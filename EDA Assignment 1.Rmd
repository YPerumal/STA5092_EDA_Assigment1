---
title: "STA5092Z: Assigment 1"
author: "Yevashan Perumal"
date: "3/30/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(gridExtra)
```

## Summary of data
The data set is availale at the following link:
https://zivahub.uct.ac.za/articles/dataset/Southern_Pied_Babbler_nestling_mass_tarsus_length_and_survival/12441899

Data were collected for each austral summer breeding season from September 2005Febru- ary 2019 (14 breeding seasons in total).

## Part 1 - Data Wrangling


```{r Import Data q2, include=FALSE}
# First Import Nestling comes first
df1 <- read.csv("./Datasets/Data.Bourne_NestlingsAllData.csv", header = TRUE)
df1 <- tibble(df1) #Convert to tibble


# Second import Fledgeling comes second
df2 <- read.csv("./Datasets/Data.Bourne_FledglingSurvival.csv", header = TRUE)
df2 <- tibble(df2) #Convert to tibble



# Third Import
df3 <- read.csv("./Datasets/Data.Bourne_NestSuccess.csv", header = TRUE)
df3 <- tibble(df3)  #Convert to tibble
```

A preview of the dataset named Data.Bourne_NestlingsAllData.csv
```{r df1, echo=FALSE}
head(df1,5)
# sum(is.na(df1$Date)) #No nulls in the date column
```


A preview of the dataset named Data.Bourne_FledglingSurvival.csv
```{r df2 echo=FALSE} 
head(df2,5)
# sum(is.na(df2$Date)) #No nulls in the date column
```
A preview of the dataset named Data.Bourne_NestSuccess.csv:
```{r df3 echo=FALSE}
head(df3,5)
```

Before merging the Nestling and Fledgling dataframes, several actions need to be taken to cleanse the data and make it ready. They are detailed below:
### Fledgeling data
* Convert all date related fields from character  to date format
* Remove any potential whitespace from character fields
* convert Surv1Mass,GrpSizeAD,GrpSizeTotal and X.Imm to numeric type from character.
* Renaming GRP to Group

### Nestling data
* Convert date related field to date format
* Convert Surv1Mass to numeric
* Remove whitespaces from character fields

It does appear from NAs were introduced during the data conversion of characater to numeric, which are for fields that did not have any data to start with.

```{r clean up dataframes q1.3, include=FALSE,echo=FALSE}
df1 <- df1 %>% 
    rename(Group=GRP)%>% 
    mutate(Date = dmy(Date),
           TwoMonthsPrior =dmy(TwoMonthsPrior),
           IncDate =dmy(IncDate),
           HatchDate =dmy(HatchDate),
           FledgeDate =dmy(FledgeDate),
           FailDate =dmy(FailDate),
           IndepDate =dmy(IndepDate),
           X1YrDate =dmy(X1YrDate),
           X2YrDate =dmy(X2YrDate),
           Surv1Mass=as.numeric(Surv1Mass),
           BirdID = str_replace_all(BirdID, " ", ""),
           Group=str_replace_all(Group, " ", ""),
           Season=str_replace_all(Season, " ", ""),
           NestID=str_replace_all(NestID, " ", ""),
           GrpSizeAD=as.numeric(GrpSizeAD),
           GrpSizeTotal=as.numeric(GrpSizeTotal),
           X.Imm=as.numeric(X.Imm)
           )%>%
    arrange(BirdID,Date,Group,Season)

df2 <- df2 %>%
    mutate(Date = dmy(Date),
           Surv1Mass=as.numeric(Surv1Mass),
           BirdID = str_replace_all(BirdID, " ", ""),
           Group=str_replace_all(Group, " ", ""),
           Season=str_replace_all(Season, " ", ""),
           NestID=str_replace_all(NestID, " ", ""),) %>% 
    arrange(BirdID,Date,Group,Season)
```

```{r merge q1.3 ,echo=FALSE}
#V1
# Spiedbabbler <- df1%>% left_join(df2,by=c('Date','BirdID','Group','Season','NestID'))

# V2
Spiedbabbler <- df1%>% left_join(df2)
# head(Spiedbabbler,5)
# print(dim(df1))
# print(dim(df2))
# print(dim(Spiedbabbler))
#Nestling comes first!
d <- dim(Spiedbabbler)
```
The dimensions of the merged data set are  `r d[1]` rows and `r d[2]` columns.

## Part 2

The Total Sample Size Per Year:
```{r q2.1, echo=FALSE}
#Total Sample Size Per Year
size_per_year <-Spiedbabbler %>%
    mutate(year=year(Date)) %>%
    select(c(year,BirdID))%>%
    group_by(year)%>%
    summarise(n = n())
    # summarise(sample_size==count(BirdID))


# print(size_per_year)
#Print as a table
knitr::kable(
  size_per_year, 
  caption = "The Total Sample Size Per Year"
)
```


```{r q2.2 Nulls,echo=FALSE}
#Check for nulls per column
miss_val <-Spiedbabbler %>%
    select(c(GrpSizeAD,GrpSizeTotal,BroodSize,Mass,TMaxMeas,
             No.ChicksFledge,TotRain,Drought))%>%
    sapply(function(x) sum(is.na(x)))
#Print in a nice table?
# miss_val

# ?knitr::kable
knitr::kable(
  miss_val, 
  caption = "Number of Missing Values in Selected Fields",
)

```

Boxplots to allow us to look for outliers:
```{r q2.2 outliers echo=FALSE}
# v1
# Spiedbabbler %>%
#     select(c(GrpSizeAD,GrpSizeTotal,BroodSize,Mass,TMaxMeas,
#              No.ChicksFledge,TotRain,Drought))%>%
#     boxplot()


# V2
b1<-Spiedbabbler %>%
    select(c(GrpSizeAD,GrpSizeTotal,BroodSize,Mass,TMaxMeas,
             No.ChicksFledge,TotRain,Drought))%>%
    ggplot(aes(y=GrpSizeAD))+
    geom_boxplot()

b2 <- Spiedbabbler %>%
    select(c(GrpSizeAD,GrpSizeTotal,BroodSize,Mass,TMaxMeas,
             No.ChicksFledge,TotRain,Drought))%>%
    ggplot(aes(y=GrpSizeTotal))+
    geom_boxplot()

b3<-Spiedbabbler %>%
    select(c(GrpSizeAD,GrpSizeTotal,BroodSize,Mass,TMaxMeas,
             No.ChicksFledge,TotRain,Drought))%>%
    ggplot(aes(y=BroodSize))+
    geom_boxplot()

b4 <- Spiedbabbler %>%
    select(c(GrpSizeAD,GrpSizeTotal,BroodSize,Mass,TMaxMeas,
             No.ChicksFledge,TotRain,Drought))%>%
    ggplot(aes(y=Mass))+
    geom_boxplot()

b5<-Spiedbabbler %>%
    select(c(GrpSizeAD,GrpSizeTotal,BroodSize,Mass,TMaxMeas,
             No.ChicksFledge,TotRain,Drought))%>%
    ggplot(aes(y=TMaxMeas))+
    geom_boxplot()

b6 <- Spiedbabbler %>%
    select(c(GrpSizeAD,GrpSizeTotal,BroodSize,Mass,TMaxMeas,
             No.ChicksFledge,TotRain,Drought))%>%
    ggplot(aes(y=No.ChicksFledge))+
    geom_boxplot()

b7<-Spiedbabbler %>%
    select(c(GrpSizeAD,GrpSizeTotal,BroodSize,Mass,TMaxMeas,
             No.ChicksFledge,TotRain,Drought))%>%
    ggplot(aes(y=TotRain))+
    geom_boxplot()

b8 <- Spiedbabbler %>%
    select(c(GrpSizeAD,GrpSizeTotal,BroodSize,Mass,TMaxMeas,
             No.ChicksFledge,TotRain,Drought))%>%
    ggplot(aes(y=Drought))+
    geom_boxplot()

grid.arrange(b1,b2,b3,b4,b5,b6,b7,b8, nrow = 2,ncol=4)
```
An outlier is an observation that lies 1.5 times the interquartile range, either below the lower quartile or above the upper quartile i.e. any obersvations further out than the "whiskers' on a box plot.

The following variables appear to have 1 or more outliers:
* GrpSizeAD
* GrpSizeTotal
* BroodSize
* Mass
* TMaxMeas

The following variable appear to not have outliers:
* No.ChicksFledge
* TotRain

The variable Drought appears to be a binary indicator (1/0) as to whether a drought occurred in that year, and thus would not have any outliers (unless there were errors in the data).

```{r q2.3 per nest per date mass echo=FALSE}
mass_by_nest<-Spiedbabbler%>%
    select(NestID,Date,Mass)%>%
    group_by(NestID,Date)%>%
    summarise('Average Mass'=round(mean(Mass),2),'Total Mass'=sum(Mass))%>%
    arrange(NestID,Date)

mass_by_nest    
knitr::kable(
  head(mass_by_nest,5), 
  caption = "Preview of DataFrame Mass and Date per Nest"
)
```
The dimensions of the table are `r dim(mass_by_nest)[1]` rows and `r dim(mass_by_nest)[2]` columns.

NEED TO COME BACK TO THIS ONE
```{r q2.4 echo=FALSE} 
# Spiedbabbler%>%
#     select(Season,TMaxMeas,TMinMeas,TvarMeas)
#     na.omit()%>%
   # summarise(average_high_temp=mean(TMaxMeas),average_low_temp=mean(TMinMeas))%>%
# sum(is.na(Spiedbabbler$TvarMeas))

diff <-Spiedbabbler%>%
    select(Season,TvarMeas,TMaxMeas,TMinMeas)%>%
    na.omit()%>% #There are null values for some observations
    group_by(Season)%>%
    summarise('Average Daily Change Temperature'=round(mean(TvarMeas),2),'
              Max Temp Observed'=round(max(TMaxMeas),2),
              'Min Temp Observed'=round(min(TMinMeas),2))

diff


# %>%
#     mutate(rn=row_number())


# knitr::kable(
#   diff, 
#   caption = "Comparison of Temperature Measures per Season"
# )
# plto_labs <- list(diff$Season)
# typeof(plto_labs)
# diff %>% ggplot(aes(x=factor(rn),y=mean_change))+
#           geom_point(aes(type='l')) +
#           scale_x_discrete(breaks = 1:13, labels=plto_labs)
```
From the table we see that both maximum and minimum temperatures appear to be on a downward trend. However the average daily temperature variability does not appear to any significant trends that we can pick out.

```{r q2.5 echo=FALSE}
Spiedbabbler%>%
    select(NestID,Date,Mass,Season)%>%
    group_by(NestID,Date,Season)%>%
    summarise(avg_mass=mean(Mass))%>%
    ggplot(aes(x=Date,y=avg_mass,color=Season))+
    geom_point()+
    ylab("Season")+
    labs(title = "Average Mass per Nest Over Time,faceted per Season")+
    facet_wrap(~Season,scales='free_x')

```

```{r q2.6 echo=FALSE}
p1 <-Spiedbabbler%>%
    mutate(year=year(Date))%>%
    select(year,Mass,BroodSize,GrpSizeTotal,No.ChicksFledge,TotRain,Season,Drought)%>%
    na.omit%>%
    group_by(year,Season)%>%
    summarise(avg_mass=mean(Mass),mean_broodsize=mean(BroodSize),
              avg_grp_size=mean(GrpSizeTotal),avg_fledg_count=mean(No.ChicksFledge),
              avg_rain=mean(TotRain))%>%
    ggplot(aes(x=year))+
    geom_point(aes(y=avg_mass))+
    facet_wrap(~Season,scales = 'free_y')+
    xlab("Year")+
    ylab("Average Mass")

p2 <-Spiedbabbler%>%
    mutate(year=year(Date))%>%
    select(year,Mass,BroodSize,GrpSizeTotal,No.ChicksFledge,TotRain,Season,Drought)%>%
    na.omit%>%
    group_by(year,Season)%>%
    summarise(avg_mass=mean(Mass),mean_broodsize=mean(BroodSize),
              avg_grp_size=mean(GrpSizeTotal),avg_fledg_count=mean(No.ChicksFledge),
              avg_rain=mean(TotRain))%>%
    ggplot(aes(x=year))+
    geom_point(aes(y=mean_broodsize))+
    facet_wrap(~Season,scales = 'free_y')+
    xlab("Year")+
    ylab("Average Brood Size")
              

p3 <-Spiedbabbler%>%
    mutate(year=year(Date))%>%
    select(year,Mass,BroodSize,GrpSizeTotal,No.ChicksFledge,TotRain,Season,Drought)%>%
    na.omit%>%
    group_by(year,Season)%>%
    summarise(avg_mass=mean(Mass),mean_broodsize=mean(BroodSize),
              avg_grp_size=mean(GrpSizeTotal),avg_fledg_count=mean(No.ChicksFledge),
              avg_rain=mean(TotRain))%>%
    ggplot(aes(x=year))+
    geom_point(aes(y=avg_grp_size))+
    facet_wrap(~Season,scales = 'free_y')+
    xlab("Year")+
    ylab("Average Total Group Size")
                
p4 <-Spiedbabbler%>%
    mutate(year=year(Date))%>%
    select(year,Mass,BroodSize,GrpSizeTotal,No.ChicksFledge,TotRain,Season,Drought)%>%
    na.omit%>%
    group_by(year,Season)%>%
    summarise(avg_mass=mean(Mass),mean_broodsize=mean(BroodSize),
              avg_grp_size=mean(GrpSizeTotal),avg_fledg_count=mean(No.ChicksFledge),
              avg_rain=mean(TotRain))%>%
    ggplot(aes(x=year))+
    geom_point(aes(y=avg_fledg_count))+
    facet_wrap(~Season,scales = 'free_y')+
    xlab("Year")+
    ylab("Average No. of Fledgling Chicks")

p5 <-Spiedbabbler%>%
    mutate(year=year(Date))%>%
    select(year,Mass,BroodSize,GrpSizeTotal,No.ChicksFledge,TotRain,Season,Drought)%>%
    na.omit%>%
    group_by(year,Season)%>%
    summarise(avg_mass=mean(Mass),mean_broodsize=mean(BroodSize),
              avg_grp_size=mean(GrpSizeTotal),avg_fledg_count=mean(No.ChicksFledge),
              avg_rain=mean(TotRain))%>%
    ggplot(aes(x=year))+
    geom_point(aes(y=avg_rain))+
    facet_wrap(~Season,scales = 'free_y')+
    xlab("Year")+
    ylab("Average Total Rainfall")

# str(Spiedbabbler)
```

```{r echo=FALSE}
p1
```

```{r echo=FALSE}
p2
```

```{r echo=FALSE}
p3
```

```{r echo=FALSE}
p4
```

```{r echo=FALSE}
p5
```


```{r q2.7, echo=FALSE}
Spiedbabbler%>%
  mutate(year=year(Date))%>%
  select(year,BirdID,Sex)%>%
  group_by(year,Sex)%>%
  ggplot(aes(x=year,fill=Sex))+
  geom_bar(position = "dodge")+
  labs(title = "Distrubtion of Observed Sex over Time")+
  ylab('Number of Birds')+
  xlab("Years")
```


